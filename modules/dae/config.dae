global {
  #lan_interface: docker0
  wan_interface: auto

  log_level: info
  allow_insecure: false
  auto_config_kernel_parameter: true
}

subscription {
  my_sub: 'file://my_sub.sub'
}

dns {
  upstream {
    googledns: 'tcp+udp://dns.google:53'
    alidns: 'udp://dns.alidns.com:53'
  }
  routing {
    request {
      qtype(https) -> reject
      fallback: alidns
    }
    response {
      upstream(googledns) -> accept
      ip(geoip:private) && !qname(geosite:cn) -> googledns
      fallback: accept
    }
  }
}

group {
    proxy {
        policy: min_moving_avg
        filter: subtag(my_sub) && name(keyword: 'Hong Kong')
    }

    ai {
        policy: min_moving_avg
        filter: subtag(my_sub) && name(keyword: 'USA')
    }
}
routing {
  pname(NetworkManager) -> direct
  dip(224.0.0.0/3, 'ff00::/8') -> direct

  l4proto(udp) && dport(443) -> block
  dip(geoip:private) -> direct
  dip(geoip:cn) -> direct
  domain(geosite:cn) -> direct

  domain(
    suffix: copilot.microsoft.com,
    suffix: gateway-copilot.bingviz.microsoftapp.net,
    suffix: mobile.events.data.microsoft.com,
    suffix: graph.microsoft.com,
    suffix: analytics.adjust.com,
    suffix: analytics.adjust.net.in,
    suffix: api.revenuecat.com,
    suffix: t-msedge.net,
    suffix: cloudapp.azure.com,
    suffix: browser-intake-datadoghq.com,
    suffix: in.appcenter.ms,
    suffix: guzzoni.apple.com,
    suffix: smoot.apple.com,
    suffix: apple-relay.cloudflare.com,
    suffix: apple-relay.fastly-edge.com,
    suffix: cp4.cloudflare.com,
    suffix: apple-relay.apple.com,
    suffix: anthropic.com,
    suffix: claude.ai,
    suffix: cdn.usefathom.com,
    suffix: claudeusercontent.com,
    suffix: gstatic.com,
    keyword: 'google'
  ) -> ai

  fallback: proxy
}
